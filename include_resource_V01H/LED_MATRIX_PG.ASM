




BK0_LED_MATRIX_RAM_INIT:
	LDX	#0
BK0_LED_MATRIX_INIT_S10:
	LDA	#C_LED_MATRIX_LINE0_MASK
	STA	R_LED_BUF,X
	INX
	CPX	#(C_LED_MAT_ROW*C_LED_MAT_LINE)
	BCC	BK0_LED_MATRIX_INIT_S10
	RTS

;


;================================================
;================================================
;	在主循环中调用，一般是调用两次，在等待时和每行扫描按键后各调用一次
;================================================
;================================================
;in: M_SHARE_RAM01: 1:scannig key: when get flag: delay 1ms;; 0:main loop: no delay 
	
;-------------------------------------
;scan matrix key and LED matrix shared 
;------------------
BK0_MATRIX_LED_RESTORE:
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)	
	STZ	<M_SHARE_RAM01
.ENDIF
	BRA	BK0_MATRIX_LED_ROW_RESTORE

BK0_MATRIX_LED_ROW: ;64HZ：GAPTIME:<5.20MS
	LDA #C_BIT3
	BIT	<USER_INT_FLAG0;2MS flag
	BEQ	BK0_MATRIX_LED_ROW_HOLD_J1
	TRB <USER_INT_FLAG0

BK0_MATRIX_LED_ROW_REAL:
.IF ( C_LED_MAT_ROW .GT. 1)
	INC	<LED_ROW_PT
.ENDIF
	
;-------------------------------------
;scan matrix key and LED matrix shared 
;------------------
BK0_MATRIX_LED_ROW_RESTORE:
;--------------------------------------

.IF ( C_LED_MAT_ROW .GT. 1)
	LDA	<LED_ROW_PT
	CMP	#C_LED_MAT_ROW
	BCC	BK0_MATRIX_LED_ROW_S10
	STZ	<LED_ROW_PT
BK0_MATRIX_LED_ROW_S10:
.ENDIF
	
	LDA	#C_LED_MATRIX_LINE0_MASK
	TSB	!SR_LED_MATRIX_LINE0_PORT
.IF ( C_LED_MAT_LINE .EQ. 2 )
	LDA	#C_LED_MATRIX_LINE1_MASK
	TSB	!SR_LED_MATRIX_LINE1_PORT
.ENDIF

	JSR	BK0_MATRIX_LED_CTL_OFF ; LED off first
	
;	JSR	BK0_DELAY50US;------------prevent the led half light
	JSR BK0_DELAY10US
	
.IF ( C_LED_MAT_ROW .GT. 1)
	LDA	<LED_ROW_PT
.ELSE
	LDA	#0
.ENDIF
	ASL	A
	TAX
	JMP	(BK0_MATRIX_LED_ROW_TBL,X)
	
BK0_MATRIX_LED_ROW_HOLD_J1:
	JMP	BK0_MATRIX_LED_ROW_HOLD

BK0_MATRIX_LED_ROW_TBL:
	DW	BK0_MATRIX_LED_ROW0
.IF ( C_LED_MAT_ROW .GT. 1)
	DW	BK0_MATRIX_LED_ROW1
.ENDIF
.IF ( C_LED_MAT_ROW .GT. 2)
	DW	BK0_MATRIX_LED_ROW2
.ENDIF
.IF ( C_LED_MAT_ROW .GT. 3)
	DW	BK0_MATRIX_LED_ROW3
.ENDIF
.IF ( C_LED_MAT_ROW .GT. 4)
	DW	BK0_MATRIX_LED_ROW4
.ENDIF

BK0_MATRIX_LED_ROW0:
	
	LDA	<R_LED_BUF
;	AND	#C_LED_MATRIX_LINE0_MASK
	STA	<REG_EA
	
	LDA	#C_LED_MATRIX_ROW0_BIT
	TRB	R_LED_MATRIX_ROW0_R_PORT
	LDA	R_LED_MATRIX_ROW0_R_PORT
	STA	!SR_LED_MATRIX_ROW0_PORT ; ROW ENABLE
	
	;JSR	BK0_DELAY50US;------------prevent the led half light
	JSR BK0_DELAY10US
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<REG_EA
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT

;

.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)	
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
;--------------------------------
;	C_MKEY_MLED_SHARE_EN
;--------------------------------
;in check key
	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次
;-----------------------------------

	JMP	BK0_MATRIX_LED_CTL_OFF
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF

BK0_MATRIX_LED_ROW0_S10: ;-----  该行 不显示
	LDA	<R_LED_BUF
;	AND	#C_LED_MATRIX_LINE0_MASK
	STA	<REG_EA
	
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<REG_EA
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT

;
	LDA	#C_LED_MATRIX_ROW0_BIT
	TRB	R_LED_MATRIX_ROW0_R_PORT
	LDA	R_LED_MATRIX_ROW0_R_PORT
	STA	!SR_LED_MATRIX_ROW0_PORT ; ROW ENABLE


.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
;in check key
;	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次
	JMP	BK0_MATRIX_LED_CTL_OFF
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF


BK0_MATRIX_LED_ROW_END:
	RTS

BK0_MATRIX_LED_ROW_HOLD:
	
;--------------------------------
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BNE	BK0_MATRIX_LED_CTL_OFF ;Scanning key:也要关LED ctrl
.ENDIF
	
	RTS

.IF ( C_LED_MAT_ROW .GT. 1)
BK0_MATRIX_LED_ROW1:

	LDA	<R_LED_BUF+1
;	AND	#C_LED_MATRIX_LINE0_MASK
	STA	<REG_EA

	LDA	#C_LED_MATRIX_ROW1_BIT
	TRB	R_LED_MATRIX_ROW1_R_PORT
	LDA	R_LED_MATRIX_ROW1_R_PORT
	STA	!SR_LED_MATRIX_ROW1_PORT ; ROW ENABLE
	
	;JSR	BK0_DELAY50US;------------prevent the led half light
	JSR BK0_DELAY10US
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<REG_EA
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;

.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
BK0_MATRIX_LED_ROW1_S10: ;-----  该行 不显示
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<R_LED_BUF+1
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	LDA	#C_LED_MATRIX_ROW1_BIT
	TRB	R_LED_MATRIX_ROW1_R_PORT
	LDA	R_LED_MATRIX_ROW1_R_PORT
	STA	!SR_LED_MATRIX_ROW1_PORT ; ROW ENABLE

.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
;	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
;
.ENDIF

.IF ( C_LED_MAT_ROW .GT. 2)
BK0_MATRIX_LED_ROW2:
;.IF ( C_KEY2LED_ENABLE .EQ. 1 )
;	MR_DETECT_WLED_EN
;	BEQ	BK0_MATRIX_LED_ROW2_S10; 整行是WLED
;.ENDIF	
;
	LDA	<R_LED_BUF+2
;	AND	#C_LED_MATRIX_LINE0_MASK
	STA	<REG_EA

	LDA	#C_LED_MATRIX_ROW2_BIT
	TRB	R_LED_MATRIX_ROW2_R_PORT
	LDA	R_LED_MATRIX_ROW2_R_PORT
	STA	!SR_LED_MATRIX_ROW2_PORT ; ROW ENABLE
;	JSR	BK0_DELAY50US;------------prevent the led half light
	JSR BK0_DELAY10US
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<REG_EA
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
BK0_MATRIX_LED_ROW2_S10:  ;-----  该行 不显示
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<R_LED_BUF+2
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	LDA	#C_LED_MATRIX_ROW2_BIT
	TRB	R_LED_MATRIX_ROW2_R_PORT
	LDA	R_LED_MATRIX_ROW2_R_PORT
	STA	!SR_LED_MATRIX_ROW2_PORT ; ROW ENABLE
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
;	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
.ENDIF

.IF ( C_LED_MAT_ROW .GT. 3)
BK0_MATRIX_LED_ROW3:
;	MR_DETECT_WLED_EN
;	BEQ	BK0_MATRIX_LED_ROW3_S10

	LDA	<R_LED_BUF+3
;	AND	#C_LED_MATRIX_LINE0_MASK
	STA	<REG_EA

	LDA	#C_LED_MATRIX_ROW3_BIT
	TRB	R_LED_MATRIX_ROW3_R_PORT
	LDA	R_LED_MATRIX_ROW3_R_PORT
	STA	!SR_LED_MATRIX_ROW3_PORT ; ROW ENABLE
;	JSR	BK0_DELAY50US;------------prevent the led half light
	JSR BK0_DELAY10US
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<REG_EA
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
BK0_MATRIX_LED_ROW3_S10:  ;-----  该行 不显示
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<R_LED_BUF+3
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	LDA	#C_LED_MATRIX_ROW3_BIT
	TRB	R_LED_MATRIX_ROW3_R_PORT
	LDA	R_LED_MATRIX_ROW3_R_PORT
	STA	!SR_LED_MATRIX_ROW3_PORT ; ROW ENABLE
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
;DEBUG
;	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
.ENDIF
	

.IF ( C_LED_MAT_ROW .GT. 4)
BK0_MATRIX_LED_ROW4:
;	MR_DETECT_WLED_EN
;	BEQ	BK0_MATRIX_LED_ROW3_S10

	LDA	<R_LED_BUF+4
;	AND	#C_LED_MATRIX_LINE0_MASK
	STA	<REG_EA

	LDA	#C_LED_MATRIX_ROW4_BIT
	TRB	R_LED_MATRIX_ROW4_R_PORT
	LDA	R_LED_MATRIX_ROW4_R_PORT
	STA	!SR_LED_MATRIX_ROW4_PORT ; ROW ENABLE
;	JSR	BK0_DELAY50US;------------prevent the led half light
	JSR BK0_DELAY10US
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<REG_EA
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
BK0_MATRIX_LED_ROW4_S10:  ;-----  该行 不显示
	LDA	R_LED_MATRIX_LINE0_R_PORT
	AND	#C_LED_MATRIX_LINE0_ANDV
	ORA	<R_LED_BUF+4
	STA	R_LED_MATRIX_LINE0_R_PORT
	LDA	R_LED_MATRIX_LINE0_R_PORT
	STA	!SR_LED_MATRIX_LINE0_PORT
;
	LDA	#C_LED_MATRIX_ROW4_BIT
	TRB	R_LED_MATRIX_ROW4_R_PORT
	LDA	R_LED_MATRIX_ROW4_R_PORT
	STA	!SR_LED_MATRIX_ROW4_PORT ; ROW ENABLE
	
.IF ( C_MKEY_MLED_SHARE_EN .EQ. 1)
	LDA	<M_SHARE_RAM01
	BEQ	BK0_MATRIX_LED_ROW_END
.ELSE
	JMP	BK0_MATRIX_LED_ROW_END
.ENDIF
	
;DEBUG
;	JSR	BK0_DELAY500US; 每行显示 0.5MS / 3MS 轮到一次

	JMP	BK0_MATRIX_LED_CTL_OFF
.ENDIF



;===============================================
BK0_MATRIX_LED_CTL_OFF:


	LDA	#C_LED_MATRIX_ROW0_BIT
	TSB	R_LED_MATRIX_ROW0_R_PORT
	LDA	R_LED_MATRIX_ROW0_R_PORT
	STA	!SR_LED_MATRIX_ROW0_PORT ; ROW ENABLE
.IF ( C_LED_MAT_ROW .GT. 1)
	LDA	#C_LED_MATRIX_ROW1_BIT
	TSB	R_LED_MATRIX_ROW1_R_PORT
	LDA	R_LED_MATRIX_ROW1_R_PORT
	STA	!SR_LED_MATRIX_ROW1_PORT ; ROW ENABLE
.ENDIF
.IF ( C_LED_MAT_ROW .GT. 2)
	LDA	#C_LED_MATRIX_ROW2_BIT
	TSB	R_LED_MATRIX_ROW2_R_PORT
	LDA	R_LED_MATRIX_ROW2_R_PORT
	STA	!SR_LED_MATRIX_ROW2_PORT ; ROW ENABLE
.ENDIF
.IF ( C_LED_MAT_ROW .GT. 3)
	LDA	#C_LED_MATRIX_ROW3_BIT
	TSB	R_LED_MATRIX_ROW3_R_PORT
	LDA	R_LED_MATRIX_ROW3_R_PORT
	STA	!SR_LED_MATRIX_ROW3_PORT ; ROW ENABLE
.ENDIF
.IF ( C_LED_MAT_ROW .GT. 4)
	LDA	#C_LED_MATRIX_ROW4_BIT
	TSB	R_LED_MATRIX_ROW4_R_PORT
	LDA	R_LED_MATRIX_ROW4_R_PORT
	STA	!SR_LED_MATRIX_ROW4_PORT ; ROW ENABLE
.ENDIF
	RTS
	



.IF (C_LEDS_FLOW_ENABLE .EQ. 1) 
	
BK0_LEDS_FLOW_STOP:
;	.IF ( C_LEDS_FLOW_USE_CNT0 .EQ. 1 )
	MACRO_SET_DLYCNT0 CNT_STOP
;	.ENDIF
;	.IF (C_WLED_EXIT .EQ. 1)	
	JMP	BK0_ALL_WLED_OFF
;	.ENDIF
	RTS
	

	
BK0_LEDS_FLOW_ST:
	STZ	<R_LED_IDX
	BRA BK0_SET_LEDS_FLOW
BK0_LEDS_FLOW_NEXT:

BK0_SET_LEDS_FLOW:

;	.IF ( C_LEDS_FLOW_USE_CNT0 .EQ. 1 )
	MACRO_SET_DLYCNT0 C_LED_FSH_TIME
;	.ENDIF

;	MR_DETECT_WLED_ENABLE
;	BEQ	BK0_SET_LEDS_FLOW_END0
	
	LDA	<R_LED_IDX
	ASL	A
	ASL	A
	TAX
	LDA	T_SET_LEDS_FLOW0,X
	STA	REG_EA
	
	LDA	<R_LED_BUF+3
	AND	#80H
	ORA	REG_EA
	STA	<R_LED_BUF+3

	INC <R_LED_IDX
	LDA <R_LED_IDX
	CMP #2
	BCC BK0_SET_LEDS_FLOW_END0
	STZ <R_LED_IDX
BK0_SET_LEDS_FLOW_END0:

	RTS

T_SET_LEDS_FLOW0: ; 7KEYS
	DB	00000000B,0FFH,0FFH,0FFH
	DB	01111111B,0FFH,0FFH,0FFH
	
.ENDIF ; 
	
