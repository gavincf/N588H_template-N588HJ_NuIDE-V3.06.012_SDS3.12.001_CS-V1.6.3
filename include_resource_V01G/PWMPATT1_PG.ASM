;BK0_LED_PATT_ST
;L_PWMS_STOP_ALL
;L_PWMS_SOLVE_SUB



;=====================================
L_PWMPATT_STOP:
	
;	LDA	#C_BIT0
;	BIT	PWM_FLAG; only check bit0 as patt flag
;	BEQ	L_PWMS_STOP_W_CHK_END

	MR_STOP_PWMX_TM
	
	LDA	#C_BIT7
	TRB	PWM_FLAG ;clear flag
	M_PWMPATT_CLR_CHKEND
	
	PWM0_DISABLE
	M_PWM0_OFF
.IF ( C_PWMS_MAX .GT. 1 )
	PWM1_DISABLE
	M_PWM1_OFF
.ENDIF
.IF ( C_PWMS_MAX .GT. 2 )
	PWM2_DISABLE
	M_PWM2_OFF
.ENDIF
.IF ( C_PWMS_MAX .GT. 3 )
	PWM3_DISABLE
	M_PWM3_OFF
.ENDIF
.IF ( C_PWMS_MAX .GT. 4 )
	PWM4_DISABLE
	M_PWM4_OFF
.ENDIF

L_PWMS_STOP_W_CHK_END:
	RTS

;=====================================
;  BK0_LED_PATT_ST

	
;=================================
; Check patt end in main loop
;=================================
;	MR_DET_CHK_PWMPATT
;	BEQ	DET_PATT_QUIT
;	LDA	PWM_FLAG
;	AND	#7FH
;	BNE	DET_PATT_QUIT
;;PATT END
;	M_PWMPATT_CLR_CHKEND
;	
;	LDA	#C_BIT7
;	TRB	PWM_FLAG  ;clear flag
;	TSB	USER_FLAG_A ;SET FLAG
;
;DET_PATT_QUIT:
;====================================
	
;======================================
; Load new patt table
;=====================================


	
;===================================================
; Loop in 'ISR'
; USE: Y
;T=500US
;===================================================
L_PWMS_SOLVE_SUB:
; 7 colors show
;0;0-31
	LDA	PWM_FLAG
	BEQ	L_PWM_SOLVE_SUB_END
;PWM0 as pattern ENABLE
	INC	<PWM_LEVEL_CNT ; 0-16 ; PWM level
	LDA	<PWM_LEVEL_CNT
	CMP	#C_MAX_LEVEL
	BNE	L_PWM_DUTY_OFF_J1
	STZ	<PWM_LEVEL_CNT
;PWM CIRCLE END;-> next level/Table data
;------------------------ PWM speed
	INC	R_PWMLED_DIV
;	LDA	R_PWMLED_DIV
	BEQ	L_PWMS_SOLVE_SUB_S10

;
	JMP	L_PWM_DUTY_START
	
L_PWM_DUTY_OFF_J1:
	JMP	L_PWM_DUTY_OFF
	
L_PWMS_SOLVE_SUB_S10:
	LDA	R_PWMLED_DIV_BUF
	STA	R_PWMLED_DIV

;------------------------------------
;PWM0
	PWM0_DET_EN
	BEQ	L_PWM0_SOLVE_END
	INC	PWM_TBL_IDX
	
	JSR	L_PWM0_SOLVE_SET

L_PWM0_SOLVE_END:
;------------------------------------
;------------------------------------
;PWM1
	PWM1_DET_EN
	BEQ	L_PWM1_SOLVE_END
	INC	PWM_TBL_IDX+1

	JSR	L_PWM1_SOLVE_SET
	

L_PWM1_SOLVE_END:
;------------------------------------
;------------------------------------
;PWM2
	PWM2_DET_EN
	BEQ	L_PWM2_SOLVE_END
	INC	PWM_TBL_IDX+2

	JSR	L_PWM2_SOLVE_SET

	
L_PWM2_SOLVE_END:
;------------------------------------
;------------------------------------
;PWM3
	PWM3_DET_EN
	BEQ	L_PWM3_SOLVE_END
	INC	PWM_TBL_IDX+3

	JSR	L_PWM3_SOLVE_SET

L_PWM3_SOLVE_END:
;------------------------------------
;------------------------------------
;PWM4
	PWM4_DET_EN
	BEQ	L_PWM4_SOLVE_END
	INC	PWM_TBL_IDX+4

	JSR	L_PWM4_SOLVE_SET

L_PWM4_SOLVE_END:

;=====================================
L_PWM_SOLVE_SUB_END:
	RTS

;==================================
; 
;==================================
L_PWM_DUTY_START:
	
	PWM0_DET_EN
	BEQ	L_PWM_SOLVE_S011
	LDA	<PWM_LEVEL
	BEQ	L_PWM_SOLVE_S010
	M_PWM0_ON
	BRA	L_PWM_SOLVE_S011
L_PWM_SOLVE_S010:
	M_PWM0_OFF
L_PWM_SOLVE_S011:

.IF ( C_PWMS_MAX .GT. 1 )
	PWM1_DET_EN
	BEQ	L_PWM_SOLVE_S021
	LDA	<PWM_LEVEL+1
	BEQ	L_PWM_SOLVE_S020
	M_PWM1_ON
	BRA	L_PWM_SOLVE_S021
L_PWM_SOLVE_S020:
	M_PWM1_OFF
L_PWM_SOLVE_S021:
.ENDIF
.IF ( C_PWMS_MAX .GT. 2 )
	PWM2_DET_EN
	BEQ	L_PWM_SOLVE_S031
	LDA	<PWM_LEVEL+2
	BEQ	L_PWM_SOLVE_S030
	M_PWM2_ON
	BRA	L_PWM_SOLVE_S031
L_PWM_SOLVE_S030:
	M_PWM2_OFF
L_PWM_SOLVE_S031:
.ENDIF
.IF ( C_PWMS_MAX .GT. 3 )
	PWM3_DET_EN
	BEQ	L_PWM_SOLVE_S041
	LDA	<PWM_LEVEL+3
	BEQ	L_PWM_SOLVE_S040
	M_PWM3_ON
	BRA	L_PWM_SOLVE_S041
L_PWM_SOLVE_S040:
	M_PWM3_OFF
L_PWM_SOLVE_S041:
.ENDIF
.IF ( C_PWMS_MAX .GT. 4 )
	PWM4_DET_EN
	BEQ	L_PWM_SOLVE_S051
	LDA	<PWM_LEVEL+4
	BEQ	L_PWM_SOLVE_S050
	M_PWM4_ON
	BRA	L_PWM_SOLVE_S051
L_PWM_SOLVE_S050:
	M_PWM4_OFF
L_PWM_SOLVE_S051:
.ENDIF

	RTS

;===================================	
; DUTY OFF
;===================================	
L_PWM_DUTY_OFF:
	PWM0_DET_EN
	BEQ	L_PWM_SOLVE_S110
	LDA	<PWM_LEVEL_CNT
	CMP	<PWM_LEVEL
	BNE	L_PWM_SOLVE_S110
	M_PWM0_OFF
L_PWM_SOLVE_S110:
.IF ( C_PWMS_MAX .GT. 1 )
	PWM1_DET_EN
	BEQ	L_PWM_SOLVE_S120
	LDA	<PWM_LEVEL_CNT
	CMP	<PWM_LEVEL+1
	BNE	L_PWM_SOLVE_S120
	M_PWM1_OFF
L_PWM_SOLVE_S120
.ENDIF
.IF ( C_PWMS_MAX .GT. 2 )
	PWM2_DET_EN
	BEQ	L_PWM_SOLVE_S130
	LDA	<PWM_LEVEL_CNT
	CMP	<PWM_LEVEL+2
	BNE	L_PWM_SOLVE_S130
	M_PWM2_OFF
L_PWM_SOLVE_S130:
.ENDIF
.IF ( C_PWMS_MAX .GT. 3 )
	PWM3_DET_EN
	BEQ	L_PWM_SOLVE_S140
	LDA	<PWM_LEVEL_CNT
	CMP	<PWM_LEVEL+3
	BNE	L_PWM_SOLVE_S140
	M_PWM3_OFF
L_PWM_SOLVE_S140:
.ENDIF
.IF ( C_PWMS_MAX .GT. 4 )
	PWM4_DET_EN
	BEQ	L_PWM_SOLVE_S150
	LDA	<PWM_LEVEL_CNT
	CMP	<PWM_LEVEL+4
	BNE	L_PWM_SOLVE_S150
	M_PWM4_OFF
L_PWM_SOLVE_S150
.ENDIF
	RTS
;

L_PWMPATT_START_W_CHK:
	
	LDA	#C_BIT7
	BIT	PWM_FLAG
	BNE	L_PWMPATT_START_W_CHK_END
	TSB	PWM_FLAG
	
	JSR	BK0_START_TMG0_05MS_W_CHK

	M_PWMPATT_SET_CHKEND

L_PWMPATT_START_W_CHK_END:
	RTS

;==============================================
;IN: X
; ONE PWM START
;=============================================
L_PWMX_SOLVE_START:

	LDA	#256-4
	STA	R_PWMLED_DIV_BUF
	STA	R_PWMLED_DIV
	
	TXA
	ASL	A
	TAX
	JMP	(L_PWMX_SOLVE_START_TBL,X)
L_PWMX_SOLVE_START_TBL:
	DW	L_PWM0_SOLVE_SET
	DW	L_PWM1_SOLVE_SET
	DW	L_PWM2_SOLVE_SET
	DW	L_PWM3_SOLVE_SET
	DW	L_PWM4_SOLVE_SET
	
	

L_PWM0_SOLVE_SET:
	LDX	PWM_TBL_IDX
	LDA	PWMPATT_TBL0,X
	CMP	#0FFH
	BEQ	L_PWM0_SOLVE_S001
	CMP	#0FEH
	BNE	L_PWM0_SOLVE_S002
;END
	PWM0_DISABLE
	M_PWM0_OFF
	BRA	L_PWM0_SOLVE_S020
	
L_PWM0_SOLVE_S001:;LOOP
	STZ	PWM_TBL_IDX
	BRA	L_PWM0_SOLVE_SET
	
L_PWM0_SOLVE_S002:;DATA
	STA	<PWM_LEVEL
;
	LDA	<PWM_LEVEL
	BEQ	L_PWM0_SOLVE_S010
	M_PWM0_ON
	BRA	L_PWM0_SOLVE_S020
L_PWM0_SOLVE_S010:
	M_PWM0_OFF
L_PWM0_SOLVE_S020:
	RTS

L_PWM1_SOLVE_SET:
	LDX	PWM_TBL_IDX+1
	LDA	PWMPATT_TBL0,X
	CMP	#0FFH
	BEQ	L_PWM1_SOLVE_S001
	CMP	#0FEH
	BNE	L_PWM1_SOLVE_S002
;END
	PWM1_DISABLE
	M_PWM1_OFF
	BRA	L_PWM1_SOLVE_S020
	
L_PWM1_SOLVE_S001:;LOOP
	STZ	PWM_TBL_IDX+1
	BRA	L_PWM1_SOLVE_SET
	
L_PWM1_SOLVE_S002:;DATA
	STA	<PWM_LEVEL+1
;
	LDA	<PWM_LEVEL+1
	BEQ	L_PWM1_SOLVE_S010
	M_PWM1_ON
	BRA	L_PWM1_SOLVE_S020
L_PWM1_SOLVE_S010:
	M_PWM1_OFF
L_PWM1_SOLVE_S020:
	RTS
	
L_PWM2_SOLVE_SET:
	LDX	PWM_TBL_IDX+2
	LDA	PWMPATT_TBL0,X
	CMP	#0FFH
	BEQ	L_PWM2_SOLVE_S001
	CMP	#0FEH
	BNE	L_PWM2_SOLVE_S002
;END
	PWM2_DISABLE
	M_PWM2_OFF
	BRA	L_PWM2_SOLVE_S020
	
L_PWM2_SOLVE_S001:;LOOP
	STZ	PWM_TBL_IDX+2
	BRA	L_PWM2_SOLVE_SET
	
L_PWM2_SOLVE_S002:;DATA
	STA	<PWM_LEVEL+2
;
	LDA	<PWM_LEVEL+2
	BEQ	L_PWM2_SOLVE_S010
	M_PWM2_ON
	BRA	L_PWM2_SOLVE_S020
L_PWM2_SOLVE_S010:
	M_PWM2_OFF
L_PWM2_SOLVE_S020:
	RTS
;
L_PWM3_SOLVE_SET:
	LDX	PWM_TBL_IDX+3
	LDA	PWMPATT_TBL0,X
	CMP	#0FFH
	BEQ	L_PWM3_SOLVE_S001
	CMP	#0FEH
	BNE	L_PWM3_SOLVE_S002
;END
	PWM3_DISABLE
	M_PWM3_OFF
	BRA	L_PWM3_SOLVE_S020
	
L_PWM3_SOLVE_S001:;LOOP
	STZ	PWM_TBL_IDX+3
	BRA	L_PWM3_SOLVE_SET
	
L_PWM3_SOLVE_S002:;DATA
	STA	<PWM_LEVEL+3
;
	LDA	<PWM_LEVEL+3
	BEQ	L_PWM3_SOLVE_S010
	M_PWM3_ON
	BRA	L_PWM3_SOLVE_S020
L_PWM3_SOLVE_S010:
	M_PWM3_OFF
L_PWM3_SOLVE_S020:
	RTS
;
L_PWM4_SOLVE_SET:
	LDX	PWM_TBL_IDX+4
	LDA	PWMPATT_TBL0,X
	CMP	#0FFH
	BEQ	L_PWM4_SOLVE_S001
	CMP	#0FEH
	BNE	L_PWM4_SOLVE_S002
;END
	PWM4_DISABLE
	M_PWM4_OFF
	BRA	L_PWM4_SOLVE_S020
	
L_PWM4_SOLVE_S001:;LOOP
	STZ	PWM_TBL_IDX+4
	BRA	L_PWM4_SOLVE_SET
	
L_PWM4_SOLVE_S002:;DATA
	STA	<PWM_LEVEL+4
;
	LDA	<PWM_LEVEL+4
	BEQ	L_PWM4_SOLVE_S010
	M_PWM4_ON
	BRA	L_PWM4_SOLVE_S020
L_PWM4_SOLVE_S010:
	M_PWM4_OFF
L_PWM4_SOLVE_S020:
	RTS


;=================================================
;要做PWM的渐亮灭，
;色度为16级以上才平滑。
;500Us作为一个计数
;为不闪，频率应在64以上


L_PWM_EN_TBL:
	DB	C_BIT0
	DB	C_BIT1
	DB	C_BIT2
	DB	C_BIT3
	DB	C_BIT4
	DB	C_BIT5
	DB	C_BIT6

