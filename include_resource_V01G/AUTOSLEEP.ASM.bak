
WK_AUTOCNT:
	LDA	WB_AUTOCNT0
	ORA	WB_AUTOCNT01
	BEQ	WK_AUTOCNT_S100
	
	INC	WB_AUTOCNT0
	BNE	WK_AUTOCNT_S100
	INC	WB_AUTOCNT01
	BNE	WK_AUTOCNT_S100
;reach
	LDA	#C_AUTO_CNT_BIT
	TSB	USER_FLAG_B
WK_AUTOCNT_S100:
	JMP	WK_AUTOCNT_RET

;==============================================================
BK0_AUTOCNT_SOLVE_MUTE_WITHCHK:

.IF ( C_MS_ENABLE .EQ. 1 )
	JSR	CHK_MIDI_STATUS
	BNE	BK0_AUTOCNT_SOLVE
.ENDIF ; C_MS_ENABLE .EQ. 1

.IF	(C_SPCH1_ENABLE .EQ. 1)
	CHK_BUSY_CH1
	BNE	BK0_AUTOCNT_SOLVE
.ENDIF

.IF	(C_SPCH2_ENABLE .EQ. 1)
	CHK_BUSY_CH2
	BNE	BK0_AUTOCNT_SOLVE
.ENDIF

.IF	(C_SPCH3_ENABLE .EQ. 1)
	CHK_BUSY_CH3
	BNE	BK0_AUTOCNT_SOLVE
.ENDIF

	BRA	BK0_AUTOCNT_SOLVE_MUTE
	
BK0_AUTOCNT_SOLVE:
	LDA	AUTOSLEEP_FLAG
	CMP	AUTOSLEEP_FLAG_BK
	BEQ	BK0_AUTOCNT_SOLVE_END1
	STA	AUTOSLEEP_FLAG_BK;STORE
	CMP	#0
	BNE	BK0_AUTOCNT_SOLVE_S10
;START AUTO SLEEP CNT
BK0_AUTOCNT_SOLVE_MUTE:
;	MR_DET_TRY
;	BEQ	BK0_AUTOCNT_SOLVE_S01
	MR_SET_AUTOCNT2
	
BK0_AUTOCNT_SOLVE_END1:
	RTS
BK0_AUTOCNT_SOLVE_S01:
	MR_SET_AUTOCNT2_TRYME
	RTS
BK0_AUTOCNT_SOLVE_S10:
	LDA	AUTOSLEEP_FLAG
	CMP	#C_AUTOSLEEP_MS1_BIT
	BEQ	BK0_AUTOCNT_SOLVE_S11 ;----------------------- if only midi playing:
	CMP	#C_AUTOSLEEP_DRUMP_BIT | C_AS_DRUMP_RP_CH_BIT
	BEQ	BK0_AUTOCNT_SOLVE_S12 ;----------------------- if only DRUMP playing:

	MR_STOP_AUTOCNT
	
	RTS
BK0_AUTOCNT_SOLVE_S11:
;如果在播放中有按键，重置这个计时
; - 在有按键中处理
BK0_AUTOCNT_SOLVE_S12:
;	
	MR_SET_AUTOCNT3; 
	
BK0_AUTOCNT_SOLVE_END:
	RTS
;==================================
;==================================
BK0_AUTOSLEEP_KEYIN:
;如果在播放中有按键，重置这个计时
; - 在有按键中处理
;	LDA	<SYS_MODE_NO
;	CMP	#C_GUIDE4_PLAY_MODE ; 暂停式的OKON
;	BNE	BK0_AUTOSLEEP_KEYIN_S10
	
;BK0_AUTOSLEEP_KEYIN_S10:
	
	LDA	AUTOSLEEP_FLAG
	CMP	#C_AUTOSLEEP_MS1_BIT
	BEQ	BK0_AUTOSLEEP_KEYIN_S20 ;----------------------- if only midi playing:
	CMP	#C_AUTOSLEEP_DRUMP_BIT | C_AS_DRUMP_RP_CH_BIT
	BEQ	BK0_AUTOSLEEP_KEYIN_S20 ;----------------------- if only DRUMP playing:
	
	RTS
BK0_AUTOSLEEP_KEYIN_S20:
	
	MR_SET_AUTOCNT3
	
	RTS





;===============================
;IN: X
;BK0_AUTOSLEEP_NOTEOFF:
;	MR_CMP_MODE_NO	C_PIANO_DRUMP_RP_MODE
;	BNE	BK0_AUTOSLEEP_NOTEOFF_S10
;	CPX	#3
;	BNE	BK0_AUTOSLEEP_NOTEOFF_S10
;if the drump replay mode: not off the ch3 flag
;	RTS
;BK0_AUTOSLEEP_NOTEOFF_S10:
;	LDA	BK0_AUTOSLEEP_NOTEON_TBL,X
;	TRB	<AUTOSLEEP_FLAG
;	RTS

;=================================================
BK0_AUTOSLEEP_INIT:
	STZ	<AUTOSLEEP_FLAG
	STZ	<AUTOSLEEP_FLAG_BK
	RTS

BK0_AUTOSLEEP_NOTEON_BUSY_X:
	LDA	BK0_AUTOSLEEP_NOTEON_TBL,X
	TSB	<AUTOSLEEP_FLAG
	RTS
BK0_AUTOSLEEP_NOTEON_TBL:
	DB	C_BIT4
	DB	C_BIT5
	DB	C_BIT6
	DB	C_BIT7
